# BOLD Postgres Upload

Uploading BOLD DNA barcode data to a Postgres database.

## Data sources

[BOLD_Public.06-Sep-2024](https://bench.boldsystems.org/index.php/datapackage?id=BOLD_Public.06-Sep-2024) [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/). This data package doesn't have a DOI.

## Database schema

### boldvector: vector and geospatial table

Simplified barcode records with processid, BIN, accession number, taxid, and lineage. Geocoordinates (if present) are represented as a `geometry` column and are indexed using the postgis extension. The barcode DNA sequence is represented as a vector of 1024 elements, corresponding to the frequency of 5-mers in the DNA sequence. This vector is indexed using the pgvector extension.

This table supports fast sequence similarity searching, and geospatial searching for map tiles and polygon-based searching.

```
-- DDL generated by Postico 2.1.2
-- Not all database features are supported. Do not use for backup.

-- Table Definition ----------------------------------------------

CREATE TABLE boldvector (
    processid character varying(32) PRIMARY KEY,
    bin_uri character varying(32),
    identification character varying(256),
    lineage text,
    taxid integer,
    insdc_acs character varying(32),
    marker_code character varying(32),
    coord geometry,
    embedding vector(1024)
);

-- Indices -------------------------------------------------------

CREATE UNIQUE INDEX boldvector_pkey ON boldvector(processid text_ops);
CREATE INDEX boldvector_coord_idx ON boldvector USING GIST (coord gist_geometry_ops_2d);
```

### Full metadata

Full metadata for each barcode from the original data package.

## Converting data


## Uploading data

Upload data directly to Postgres in cloud using small batches, e.g. 1000.

## Indexing

### boldvector

```
SET maintenance_work_mem TO '3929MB';

CREATE INDEX ON boldvector USING ivfflat (embedding vector_l2_ops) WITH (lists = 4000);
```

Number of lists is SQRT(number of rows)

Took about 4 hours to index on Ubuntu with 16GB RAM and 240GB disk, used 100% RAM
