# BOLD Postgres Upload

Uploading BOLD DNA barcode data to a Postgres database.

## Data sources

[BOLD_Public.06-Sep-2024](https://bench.boldsystems.org/index.php/datapackage?id=BOLD_Public.06-Sep-2024) [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/). This data package doesn't have a DOI.

## Database

The database is Postgres with the postgis and pgvector extensions.

### Schema

#### boldvector: vector and geospatial table

Simplified barcode records with processid, BIN, accession number, taxid, and lineage. Geocoordinates (if present) are represented as a `geometry` column and are indexed using the postgis extension. The barcode DNA sequence is represented as a vector of 1024 elements, corresponding to the frequency of 5-mers in the DNA sequence. This vector is indexed using the pgvector extension.

This table supports fast sequence similarity searching, and geospatial searching for map tiles and polygon-based searching.

Note that we create everything but the primary key index after loading the data. The vector indexing takes a few hours to complete.

```
-- DDL generated by Postico 2.1.2
-- Not all database features are supported. Do not use for backup.

-- Table Definition ----------------------------------------------

CREATE TABLE boldvector (
    processid character varying(32) PRIMARY KEY,
    bin_uri character varying(32),
    identification character varying(256),
    lineage text,
    taxid integer,
    insdc_acs character varying(32),
    marker_code character varying(32),
    coord geometry,
    embedding vector(1024)
);

-- Indices -------------------------------------------------------

CREATE UNIQUE INDEX boldvector_pkey ON boldvector(processid text_ops);
CREATE INDEX boldvector_coord_idx ON boldvector USING GIST (coord gist_geometry_ops_2d);
CREATE INDEX boldvector_bin_uri_idx ON boldvector(bin_uri text_ops);
CREATE INDEX boldvector_identification_idx ON boldvector(identification text_ops);
CREATE INDEX boldvector_marker_code_idx ON boldvector(marker_code text_ops);
CREATE INDEX boldvector_taxid_idx ON boldvector(taxid int4_ops);
```

#### Full metadata

Full metadata for each barcode from the original data package.

```
-- DDL generated by Postico 2.1.2
-- Not all database features are supported. Do not use for backup.

-- Table Definition ----------------------------------------------

CREATE TABLE boldmeta (
    processid text PRIMARY KEY,
    sampleid text,
    fieldid text,
    museumid text,
    record_id text,
    specimenid integer,
    processid_minted_date date,
    bin_uri text,
    bin_created_date date,
    collection_code text,
    inst text,
    sovereign_inst text,
    taxid integer,
    kingdom text,
    phylum text,
    class text,
    "order" text,
    family text,
    subfamily text,
    tribe text,
    genus text,
    species text,
    subspecies text,
    species_reference text,
    identification text,
    identification_method text,
    identification_rank text,
    identified_by text,
    identifier_email text,
    taxonomy_notes text,
    sex character(1),
    reproduction text,
    life_stage text,
    short_note text,
    notes text,
    voucher_type text,
    tissue_type text,
    specimen_linkout text,
    associated_specimens text,
    associated_taxa text,
    collectors text,
    collection_date_start date,
    collection_date_end date,
    collection_event_id text,
    collection_time text,
    collection_notes text,
    geoid integer,
    "country/ocean" text,
    country_iso text,
    "province/state" text,
    region text,
    sector text,
    site text,
    site_code text,
    coord text,
    coord_accuracy real,
    coord_source text,
    elev real,
    elev_accuracy real,
    depth real,
    depth_accuracy real,
    habitat text,
    realm text,
    biome text,
    ecoregion text,
    sampling_protocol text,
    nuc text,
    nuc_basecount integer,
    insdc_acs text,
    funding_src text,
    marker_code text,
    primers_forward text[],
    primers_reverse text[],
    sequence_run_site text,
    sequence_upload_date date,
    bold_recordset_code_arr text[]
);

-- Indices -------------------------------------------------------

CREATE UNIQUE INDEX boldmeta_pkey ON boldmeta(processid text_ops);
CREATE INDEX boldmeta_bin_uri_idx ON boldmeta(bin_uri text_ops);
CREATE INDEX boldmeta_country_iso_idx ON boldmeta(country_iso text_ops);
CREATE INDEX boldmeta_bold_recordset_code_arr_idx ON boldmeta USING GIN (bold_recordset_code_arr array_ops);
```

#### Images

BOLD does not provide a list of images so we extract these from GBIF.

```
-- DDL generated by Postico 2.1.2
-- Not all database features are supported. Do not use for backup.

-- Table Definition ----------------------------------------------

CREATE TABLE boldimage (
    processid text NOT NULL,
    url text PRIMARY KEY,
    title text,
    view text,
    mimetype text NOT NULL,
    license text,
    clean_license text
);

-- Indices -------------------------------------------------------

CREATE UNIQUE INDEX boldimage_pkey ON boldimage(url text_ops);
CREATE INDEX boldimage_processid_idx ON boldimage(processid text_ops);
```

### Uploading data

Upload data directly to Postgres in cloud using small batches, e.g. 1000.

### Indexing

In addition to standard indices to help lookup values these are some specialised indices on some tables.

#### boldvector

The k-mer vector is made searchable using a vector index.

```
SET maintenance_work_mem TO '3929MB';

CREATE INDEX ON boldvector USING ivfflat (embedding vector_l2_ops) WITH (lists = 4000);
```

Number of lists is SQRT(number of rows)

Took about 4 hours to index on Ubuntu with 16GB RAM and 240GB disk, used 100% RAM

#### boldmeta

We use an array index on `bold_recordset_code_arr` so we can easily search for a specific recordset_code.

```
CREATE INDEX boldmeta_bold_recordset_code_arr_idx ON boldmeta USING GIN (bold_recordset_code_arr array_ops);
```





